<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Torrent Wizard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e1e2e 0%, #181825 100%);
        color: #cdd6f4;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 300px;
        background: #11111b;
        border-right: 1px solid #313244;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .content {
        flex: 1;
        min-width: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      .step {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .step:hover {
        background: #313244;
      }

      .step.disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }

      .step.disabled:hover {
        background: transparent;
      }

      .step.active {
        background: #313244;
        border-color: #89b4fa;
      }

      .step.completed {
        background: #1e1e2e;
        border-color: #a6e3a1;
      }

      .step.completed:hover {
        background: #313244;
        border-color: #a6e3a1;
      }

      .step.error {
        background: #1e1e2e;
        border-color: #f38ba8;
      }

      .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #45475a;
        color: #cdd6f4;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        font-size: 14px;
      }

      .step.active .step-number {
        background: #89b4fa;
        color: #11111b;
      }

      .step.completed .step-number {
        background: #a6e3a1;
        color: #11111b;
      }

      .step.error .step-number {
        background: #f38ba8;
        color: #11111b;
      }

      .step-title {
        font-weight: 500;
        font-size: 14px;
      }

      .main-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      .header {
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 600;
        color: #cdd6f4;
        margin-bottom: 8px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .header p {
        color: #a6adc8;
        font-size: 16px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .card {
        background: #1e1e2e;
        border: 1px solid #313244;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        max-width: 100%;
        overflow: hidden;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: #cdd6f4;
      }

      .form-control {
        width: 100%;
        padding: 12px 16px;
        background: #11111b;
        border: 2px solid #313244;
        border-radius: 8px;
        color: #cdd6f4;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: #89b4fa;
        background: #1e1e2e;
      }

      .servers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }

      .server-card {
        background: #11111b;
        border: 2px solid #313244;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .server-card:hover {
        border-color: #585b70;
        background: #1e1e2e;
      }

      .server-card.selected {
        border-color: #89b4fa;
        background: #1e1e2e;
      }

      .server-card.offline {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .server-card.offline:hover {
        border-color: #313244;
        background: #11111b;
      }

      .server-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .server-name {
        font-size: 16px;
        font-weight: 600;
        color: #cdd6f4;
      }

      .server-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #45475a;
      }

      .server-status.online {
        background: #a6e3a1;
        box-shadow: 0 0 8px #a6e3a1;
      }

      .server-status.offline {
        background: #f38ba8;
      }

      .server-metrics {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .metric-label {
        color: #a6adc8;
      }

      .metric-value {
        color: #cdd6f4;
        font-weight: 600;
      }

      .metric-bar-container {
        width: 100%;
        height: 6px;
        background: #313244;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 4px;
      }

      .metric-bar {
        height: 100%;
        background: #89b4fa;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .metric-bar.high {
        background: #f9e2af;
      }

      .metric-bar.critical {
        background: #f38ba8;
      }

      .server-loading {
        text-align: center;
        color: #a6adc8;
        padding: 20px;
        font-size: 14px;
      }

      .server-footer {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #313244;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .server-footer .btn {
        padding: 8px 16px;
        font-size: 12px;
        width: 100%;
      }

      .btn-speedtest {
        background: #313244;
        color: #cdd6f4;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .btn-speedtest:hover {
        background: #45475a;
      }

      .monitoring-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: #6c7086;
        padding: 4px 8px;
        background: #313244;
        border-radius: 4px;
      }

      .monitoring-badge.connected {
        color: #a6e3a1;
        background: rgba(166, 227, 161, 0.1);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #89b4fa;
        color: #11111b;
      }

      .btn-primary:hover {
        background: #74c7ec;
      }

      .btn-secondary {
        background: #45475a;
        color: #cdd6f4;
      }

      .btn-secondary:hover {
        background: #585b70;
      }

      .btn-success {
        background: #a6e3a1;
        color: #11111b;
      }

      .btn-danger {
        background: #f38ba8;
        color: #11111b;
      }

      .log-container {
        flex: 1;
        background: #11111b;
        border: 1px solid #313244;
        border-radius: 8px;
        padding: 16px;
        overflow-y: auto;
        overflow-x: auto;
        max-height: 300px;
        height: 300px;
        max-width: 100%;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 13px;
        line-height: 1.5;
        word-break: break-all;
      }

      .log-entry {
        margin-bottom: 4px;
        padding: 4px 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .log-entry.info {
        color: #89b4fa;
      }

      .log-entry.success {
        color: #a6e3a1;
      }

      .log-entry.error {
        color: #f38ba8;
      }

      .log-entry.warning {
        color: #f9e2af;
      }

      .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #313244;
        border-radius: 8px;
        background: #11111b;
      }

      .file-item {
        padding: 12px 16px;
        border-bottom: 1px solid #313244;
        cursor: pointer;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .file-item:hover {
        background: #1e1e2e;
      }

      .file-item:last-child {
        border-bottom: none;
      }

      .file-item input[type="checkbox"] {
        margin: 0;
      }

      .file-name {
        flex: 1;
        min-width: 0;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .file-size {
        color: #a6adc8;
        font-size: 12px;
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .hidden {
        display: none;
      }

      .loading {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #89b4fa;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #313244;
        border-top: 2px solid #89b4fa;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(0.8);
        }
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #313244;
        border-radius: 3px;
        overflow: hidden;
        margin: 16px 0;
      }

      .progress-fill {
        height: 100%;
        background: #89b4fa;
        border-radius: 3px;
        transition: width 0.3s ease;
        width: 0%;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #11111b;
      }

      ::-webkit-scrollbar-thumb {
        background: #45475a;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #585b70;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <div class="step" data-step="1">
          <div class="step-number">1</div>
          <div class="step-title">–í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-title">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-title">–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-title">–í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤</div>
        </div>
        <div class="step" data-step="5">
          <div class="step-number">5</div>
          <div class="step-title">–í—ã–±–æ—Ä –ø–ª–µ–µ—Ä–∞</div>
        </div>
        <div class="step" data-step="6">
          <div class="step-number">6</div>
          <div class="step-title">–ó–∞–ø—É—Å–∫</div>
        </div>
      </div>

      <div class="content">
        <div class="main-content">
          <div class="header">
            <h1 id="stepTitle">–í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞</h1>
            <p id="stepDescription">
              –í—ã–±–µ—Ä–∏—Ç–µ TorrServer –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞
            </p>
          </div>

          <div id="step1" class="step-content">
            <div class="card">
              <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <label style="margin-bottom: 0;">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã:</label>
                  <div id="monitoringStatus" class="monitoring-badge">
                    <div style="width: 6px; height: 6px; border-radius: 50%; background: #6c7086;"></div>
                    <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                  </div>
                </div>
                <div id="serversGrid" class="servers-grid">
                  <div class="server-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤...</div>
                </div>
              </div>
              <div class="button-group">
                <button id="btnSelectServer" class="btn btn-primary" disabled>
                  –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                </button>
              </div>
            </div>
          </div>

          <div id="step2" class="step-content hidden">
            <div class="card">
              <div class="loading">
                <div class="spinner"></div>
                <span>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill"></div>
              </div>
            </div>
          </div>

          <div id="step3" class="step-content hidden">
            <div class="card">
              <div class="loading">
                <div class="spinner"></div>
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö...</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill"></div>
              </div>
            </div>
          </div>

          <div id="step4" class="step-content hidden">
            <div class="card">
              <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:</label>
                <div id="fileList" class="file-list"></div>
              </div>
              <div class="button-group">
                <button id="btnSelectAll" class="btn btn-secondary">
                  –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <button id="btnSelectFiles" class="btn btn-primary">
                  –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                </button>
                <button id="btnSavePlaylist" class="btn btn-secondary">
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë –∫–∞–∫ –ø–ª–µ–π–ª–∏—Å—Ç
                </button>
                <button id="btnCopyMagnet" class="btn btn-secondary">
                  –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å magnet
                </button>
              </div>
              <div
                style="
                  margin-top: 15px;
                  padding: 12px;
                  background: #313244;
                  border-radius: 8px;
                  font-size: 13px;
                  color: #a6adc8;
                "
              >
                <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ü–ª–µ–π–ª–∏—Å—Ç –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤
                VLC, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤(–µ—Å–ª–∏ —Å–µ—Ä–∏–π –º–Ω–æ–≥–æ, —Ç–æ –Ω–∞–ø—Ä—è–º—É—é –ø–ª–µ–µ—Ä–∞
                –∏—Ö –Ω–µ –æ—Ç–∫—Ä–æ—é—Ç). –ü–ª–µ–π–ª–∏—Å—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞ –∏
                –ø–æ—Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              </div>
            </div>
          </div>

          <div id="step5" class="step-content hidden">
            <div class="card">
              <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–µ—Ä:</label>
                <div class="button-group">
                  <button id="btnInternalPlayer" class="btn btn-primary">
                    –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π (mpv)
                  </button>
                  <button id="btnExternalPlayer" class="btn btn-secondary">
                    –í–Ω–µ—à–Ω–∏–π –ø–ª–µ–µ—Ä
                  </button>
                  <button id="btnChoosePlayer" class="btn btn-secondary">
                    –°–º–µ–Ω–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –ø–ª–µ–µ—Ä
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="step6" class="step-content hidden">
            <div class="card">
              <div id="torrentStats" class="hidden" style="margin-bottom: 20px; padding: 16px; background: #313244; border-radius: 8px; max-width: 100%; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                  <h3 style="margin: 0; font-size: 16px; color: #cdd6f4;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:</h3>
                  <div id="liveIndicator" class="hidden" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #a6e3a1;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: #a6e3a1; animation: pulse 1.5s ease-in-out infinite;"></div>
                    <span>Live</span>
                  </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px;">
                  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #a6adc8;">–°–µ—Ä–≤–µ—Ä:</span>
                    <span id="statServerName" style="color: #cba6f7; font-weight: 600;">-</span>
                  </div>
                  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #a6adc8;">–ü–∏—Ä—ã:</span>
                    <span id="statTotalPeers" style="color: #89b4fa; font-weight: 600;">-</span>
                  </div>
                  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #a6adc8;">–°–∏–¥—ã:</span>
                    <span id="statActivePeers" style="color: #a6e3a1; font-weight: 600;">-</span>
                  </div>
                  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #a6adc8;">–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —Å–µ—Ä–≤–µ—Ä–æ–º:</span>
                    <span id="statDownloadSpeed" style="color: #89b4fa; font-weight: 600;">-</span>
                  </div>
                  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #a6adc8;">–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏(–∫–ª–∏–µ–Ω—Ç/–ø–ª–µ–µ—Ä):</span>
                    <span id="statClientDownloadSpeed" style="color: #f9e2af; font-weight: 600;">-</span>
                  </div>
                  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #a6adc8;">–†–∞–∑–º–µ—Ä —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:</span>
                    <span id="statTorrentSize" style="color: #cdd6f4; font-weight: 600;">-</span>
                  </div>
                </div>
              </div>
              <div id="playerLoading" class="loading">
                <div class="spinner"></div>
                <span>–ó–∞–ø—É—Å–∫ –ø–ª–µ–µ—Ä–∞...</span>
              </div>
            </div>
          </div>

          <div class="card" style="flex: 1; min-height: 200px">
            <div
              class="form-group"
              style="
                margin-bottom: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <label>–õ–æ–≥–∏:</label>
              <button
                id="btnCopyLog"
                class="btn btn-secondary"
                style="padding: 8px 16px; font-size: 12px"
              >
                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥
              </button>
            </div>
            <div id="logContainer" class="log-container"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      let currentStep = 1;
      let maxAvailableStep = 1;
      let magnetUrl = "";
      let selectedServer = "";
      let selectedServerName = "";
      let torrentHash = "";
      let torrentFiles = [];
      let selectedFiles = [];
      let currentStats = null;
      
      let monitorWs = null;
      let serversData = [];
      let serverMetrics = {};
      let monitorServerUrl = "";

      function updateStep(step, allowNavigation = false) {
        if (step > maxAvailableStep) {
          maxAvailableStep = step;
        }

        document.querySelectorAll(".step").forEach((s) => {
          const stepNum = parseInt(s.dataset.step);
          s.classList.remove("active", "completed", "error", "disabled");

          if (stepNum === step) {
            s.classList.add("active");
          } else if (
            stepNum < step ||
            (stepNum <= maxAvailableStep && allowNavigation)
          ) {
            s.classList.add("completed");
          } else if (stepNum > maxAvailableStep) {
            s.classList.add("disabled");
          }
        });

        document.querySelectorAll(".step-content").forEach((content) => {
          content.classList.add("hidden");
        });

        const currentContent = document.getElementById(`step${step}`);
        if (currentContent) {
          currentContent.classList.remove("hidden");
        }

        const titles = {
          1: "–í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞",
          2: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞",
          3: "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤",
          4: "–í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤",
          5: "–í—ã–±–æ—Ä –ø–ª–µ–µ—Ä–∞",
          6: "–ó–∞–ø—É—Å–∫",
        };

        const descriptions = {
          1: "–í—ã–±–µ—Ä–∏—Ç–µ TorrServer –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞",
          2: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–Ω–µ—Ç-—Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä",
          3: "–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö —Ç–æ—Ä—Ä–µ–Ω—Ç–∞",
          4: "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è",
          5: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–µ—Ä –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è",
          6: "–ó–∞–ø—É—Å–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞",
        };

        document.getElementById("stepTitle").textContent = titles[step] || "";
        document.getElementById("stepDescription").textContent =
          descriptions[step] || "";

        currentStep = step;
      }

      function navigateToStep(targetStep) {
        if (targetStep <= maxAvailableStep) {
          updateStep(targetStep, true);
        }
      }

      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;

        const timestamp = new Date().toLocaleTimeString();
        logEntry.textContent = `[${timestamp}] ${message}`;

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function setStepError(step) {
        const stepElement = document.querySelector(
          `.step[data-step="${step}"]`
        );
        if (stepElement) {
          stepElement.classList.remove("active", "completed");
          stepElement.classList.add("error");
        }
      }

      function updateMonitoringStatus(connected) {
        const badge = document.getElementById('monitoringStatus');
        if (!badge) return;
        
        if (connected) {
          badge.className = 'monitoring-badge connected';
          badge.innerHTML = `
            <div style="width: 6px; height: 6px; border-radius: 50%; background: #a6e3a1; box-shadow: 0 0 4px #a6e3a1;"></div>
            <span>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω</span>
          `;
        } else {
          badge.className = 'monitoring-badge';
          badge.innerHTML = `
            <div style="width: 6px; height: 6px; border-radius: 50%; background: #6c7086;"></div>
            <span>–ë–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</span>
          `;
        }
      }

      function initMonitorWebSocket() {
        if (!monitorServerUrl) {
          updateMonitoringStatus(false);
          return;
        }

        try {
          const wsUrl = monitorServerUrl.replace('http://', 'ws://').replace('https://', 'wss://');
          monitorWs = new WebSocket(wsUrl);

          monitorWs.onopen = () => {
            console.log('Connected to monitoring server');
            addLog('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞', 'success');
            updateMonitoringStatus(true);
          };

          monitorWs.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'init') {
              serverMetrics = data.metrics;
              updateServersDisplay();
            } else if (data.type === 'metrics') {
              serverMetrics[data.serverId] = data.metrics;
              updateServerCard(data.serverId, data.metrics);
            }
          };

          monitorWs.onerror = (error) => {
            console.error('WebSocket error:', error);
            addLog('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ä–∞–±–æ—Ç–∞ –±–µ–∑ –º–µ—Ç—Ä–∏–∫)', 'warning');
            updateMonitoringStatus(false);
            updateServersDisplay();
          };

          monitorWs.onclose = () => {
            console.log('Disconnected from monitoring server');
            updateMonitoringStatus(false);
          };
        } catch (error) {
          console.error('Failed to connect to monitoring server:', error);
          addLog('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ä–∞–±–æ—Ç–∞ –±–µ–∑ –º–µ—Ç—Ä–∏–∫)', 'warning');
          updateMonitoringStatus(false);
          updateServersDisplay();
        }
      }

      function createServerCard(server, index, metrics) {
        const hasMetrics = metrics && metrics.status;
        const isOnline = hasMetrics ? metrics.status === 'online' : true;
        const cpu = hasMetrics ? metrics.cpu.toFixed(1) : '-';
        const ram = hasMetrics ? metrics.ram.toFixed(1) : '-';
        const netUp = hasMetrics ? formatMegabits(metrics.network.upload) : '-';
        const netDown = hasMetrics ? formatMegabits(metrics.network.download) : '-';
        
        const netUpMbps = hasMetrics ? (metrics.network.upload * 8) / 1000000 : 0;
        const netUpPercent = Math.min((netUpMbps / 1000) * 100, 100);

        const statusClass = hasMetrics ? (isOnline ? 'online' : 'offline') : '';
        const cardClass = hasMetrics ? (isOnline ? '' : 'offline') : '';

        return `
          <div class="server-card ${cardClass}" data-server-index="${index}" data-server-id="${server.id}">
            <div class="server-header">
              <div class="server-name">${server.location}</div>
              ${hasMetrics ? `<div class="server-status ${statusClass}"></div>` : '<div class="server-status" style="background: #6c7086;"></div>'}
            </div>
            <div class="server-metrics">
              <div class="metric-row">
                <span class="metric-label">CPU:</span>
                <span class="metric-value" id="cpu-${server.id}">${hasMetrics ? cpu + '%' : '-'}</span>
              </div>
              
              <div class="metric-row">
                <span class="metric-label">RAM:</span>
                <span class="metric-value" id="ram-${server.id}">${hasMetrics ? ram + '%' : '-'}</span>
              </div>
              
              <div class="metric-row">
                <span class="metric-label">Network ‚Üì:</span>
                <span class="metric-value" id="net-down-${server.id}">${netDown}</span>
              </div>
              
              <div class="metric-row">
                <span class="metric-label">Network ‚Üë:</span>
                <span class="metric-value" id="net-up-${server.id}">${netUp}</span>
              </div>
            </div>
            
            ${hasMetrics ? `<div class="metric-bar-container" style="margin: 12px 0 0 0;">
              <div class="metric-bar ${netUpPercent > 80 ? 'critical' : netUpPercent > 60 ? 'high' : ''}" 
                   id="net-up-bar-${server.id}" style="width: ${netUpPercent}%"></div>
            </div>` : ''}
            
            <div class="server-footer">
              <a href="${server.speedtestUrl}" target="_blank" class="btn btn-speedtest" onclick="event.stopPropagation();">
                ‚ö° Speed Test
              </a>
            </div>
          </div>
        `;
      }

      function updateServersDisplay() {
        const grid = document.getElementById('serversGrid');
        if (!grid) return;

        grid.innerHTML = '';
        
        serversData.forEach((server, index) => {
          const metrics = serverMetrics[server.id];
          const cardHtml = createServerCard(server, index, metrics);
          grid.insertAdjacentHTML('beforeend', cardHtml);
        });

        document.querySelectorAll('.server-card').forEach(card => {
          card.addEventListener('click', () => {
            if (card.classList.contains('offline')) {
              addLog('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
              return;
            }

            document.querySelectorAll('.server-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            selectedServer = card.dataset.serverIndex;
            const server = serversData[selectedServer];
            if (server) {
              selectedServerName = server.location;
            }

            document.getElementById('btnSelectServer').disabled = false;
          });
        });
      }

      function updateServerCard(serverId, metrics) {
        const card = document.querySelector(`[data-server-id="${serverId}"]`);
        if (!card) return;

        const isOnline = metrics.status === 'online';
        const cpu = metrics.cpu.toFixed(1);
        const ram = metrics.ram.toFixed(1);
        const netUp = formatMegabits(metrics.network.upload);
        const netDown = formatMegabits(metrics.network.download);
        
        const netUpMbps = (metrics.network.upload * 8) / 1000000;
        const netUpPercent = Math.min((netUpMbps / 1000) * 100, 100);

        const cpuEl = document.getElementById(`cpu-${serverId}`);
        if (cpuEl) cpuEl.textContent = `${cpu}%`;

        const ramEl = document.getElementById(`ram-${serverId}`);
        if (ramEl) ramEl.textContent = `${ram}%`;

        const netDownEl = document.getElementById(`net-down-${serverId}`);
        const netUpEl = document.getElementById(`net-up-${serverId}`);
        if (netDownEl) netDownEl.textContent = netDown;
        if (netUpEl) netUpEl.textContent = netUp;

        const netUpBarEl = document.getElementById(`net-up-bar-${serverId}`);
        if (netUpBarEl) {
          netUpBarEl.style.width = `${netUpPercent}%`;
          netUpBarEl.className = `metric-bar ${netUpPercent > 80 ? 'critical' : netUpPercent > 60 ? 'high' : ''}`;
        } else {
          const metricsDiv = card.querySelector('.server-metrics');
          const footer = card.querySelector('.server-footer');
          if (metricsDiv && footer && !card.querySelector('#net-up-bar-' + serverId)) {
            const barContainer = document.createElement('div');
            barContainer.className = 'metric-bar-container';
            barContainer.style.margin = '12px 0 0 0';
            barContainer.innerHTML = `<div class="metric-bar ${netUpPercent > 80 ? 'critical' : netUpPercent > 60 ? 'high' : ''}" id="net-up-bar-${serverId}" style="width: ${netUpPercent}%"></div>`;
            footer.parentNode.insertBefore(barContainer, footer);
          }
        }

        const statusEl = card.querySelector('.server-status');
        if (statusEl) {
          statusEl.className = `server-status ${isOnline ? 'online' : 'offline'}`;
          statusEl.style.background = '';
        }
        
        if (isOnline) {
          card.classList.remove('offline');
        } else {
          card.classList.add('offline');
        }
      }

      function formatMegabits(bytesPerSecond) {
        const megabits = (bytesPerSecond * 8) / 1000000;
        
        if (megabits < 0.1) {
          return '0.0 Mb/s';
        } else if (megabits < 10) {
          return megabits.toFixed(1) + ' Mb/s';
        } else {
          return megabits.toFixed(0) + ' Mb/s';
        }
      }

      ipcRenderer.on("init-wizard", (event, data) => {
        magnetUrl = data.magnetUrl;
        serversData = data.servers;
        monitorServerUrl = data.monitorServerUrl;

        const logContainer = document.getElementById("logContainer");
        logContainer.innerHTML = "";

        addLog(`–í–µ—Ä—Å–∏—è: ${data.appVersion}`, "info");
        addLog(`Magnet URL: ${magnetUrl.substring(0, 100)}...`);
        
        initMonitorWebSocket();
        
        // Show initial server cards (without metrics)
        updateServersDisplay();

        if (data.platform !== "win32") {
          const internalPlayerBtn =
            document.getElementById("btnInternalPlayer");
          if (internalPlayerBtn) {
            internalPlayerBtn.style.display = "none";
            addLog("–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–ª–µ–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ Windows", "info");
          }
        }

        document.querySelectorAll(".step").forEach((stepElement) => {
          stepElement.addEventListener("click", () => {
            const stepNumber = parseInt(stepElement.dataset.step);
            if (!stepElement.classList.contains("disabled")) {
              navigateToStep(stepNumber);
            }
          });
        });
      });

      document
        .getElementById("btnSelectServer")
        .addEventListener("click", () => {
          if (selectedServer === "") {
            addLog("–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä", "error");
            return;
          }

          const serverIndex = parseInt(selectedServer);
          const server = serversData[serverIndex];
          
          if (!server) {
            addLog("–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");
            return;
          }

          addLog(`–í—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–µ—Ä: ${server.location}`, "info");
          updateStep(2);

          ipcRenderer.send("server-selected", {
            serverIndex: serverIndex,
          });
        });

      document.getElementById("btnSelectAll").addEventListener("click", () => {
        const checkboxes = document.querySelectorAll(
          '#fileList input[type="checkbox"]'
        );
        const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

        checkboxes.forEach((checkbox) => {
          checkbox.checked = !allChecked;
        });

        const checkedCount = document.querySelectorAll(
          '#fileList input[type="checkbox"]:checked'
        ).length;

        if (allChecked) {
          document.getElementById("btnSelectAll").textContent = "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ";
        } else {
          document.getElementById("btnSelectAll").textContent = "–°–Ω—è—Ç—å –≤—Å–µ";
        }
      });

      document
        .getElementById("btnSelectFiles")
        .addEventListener("click", () => {
          const checkboxes = document.querySelectorAll(
            '#fileList input[type="checkbox"]:checked'
          );
          selectedFiles = Array.from(checkboxes).map((cb) =>
            parseInt(cb.value)
          );

          if (selectedFiles.length === 0) {
            addLog("–ù–µ –≤—ã–±—Ä–∞–Ω—ã —Ñ–∞–π–ª—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è", "error");
            return;
          }

          addLog(`–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${selectedFiles.length}`);
          updateStep(5);

          ipcRenderer.send("files-selected", { selectedFiles });
        });

      document
        .getElementById("btnSavePlaylist")
        .addEventListener("click", () => {
          ipcRenderer.send("save-playlist", { hash: torrentHash });
        });

      document.getElementById("btnCopyMagnet").addEventListener("click", () => {
        ipcRenderer.send("copy-magnet", { magnetUrl });
      });

      document.getElementById("btnCopyLog").addEventListener("click", () => {
        copyLogToClipboard();
      });

      document
        .getElementById("btnInternalPlayer")
        .addEventListener("click", () => {
          addLog("–í—ã–±—Ä–∞–Ω –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–ª–µ–µ—Ä (mpv)");
          ipcRenderer.send("player-selected", { playerType: "internal" });
        });

      document
        .getElementById("btnExternalPlayer")
        .addEventListener("click", () => {
          addLog("–í—ã–±—Ä–∞–Ω –≤–Ω–µ—à–Ω–∏–π –ø–ª–µ–µ—Ä");
          ipcRenderer.send("player-selected", { playerType: "external" });
        });

      document
        .getElementById("btnChoosePlayer")
        .addEventListener("click", () => {
          ipcRenderer.send("choose-player-path");
        });

      ipcRenderer.on("step-progress", (event, data) => {
        if (data.step !== null && data.step !== undefined) {
          updateStep(data.step);
        }
        if (data.message) {
          addLog(data.message, data.type || "info");
        }
      });

      ipcRenderer.on("torrent-added", (event, data) => {
        torrentHash = data.hash;
        addLog(`–¢–æ—Ä—Ä–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω. Hash: ${data.hash}`, "success");
        updateStep(3);
      });

      ipcRenderer.on("files-received", (event, data) => {
        torrentFiles = data.files;
        addLog(`–ü–æ–ª—É—á–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${data.files.length}`, "success");

        document.getElementById("btnSelectAll").textContent = "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ";

        const fileList = document.getElementById("fileList");
        fileList.innerHTML = "";

        data.files.forEach((file, index) => {
          const fileItem = document.createElement("div");
          fileItem.className = "file-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = file.id;
          checkbox.id = `file-${index}`;

          const fileName = document.createElement("div");
          fileName.className = "file-name";
          fileName.textContent = file.path;

          const fileSize = document.createElement("div");
          fileSize.className = "file-size";
          fileSize.textContent = formatFileSize(file.length);

          fileItem.appendChild(checkbox);
          fileItem.appendChild(fileName);
          fileItem.appendChild(fileSize);
          fileList.appendChild(fileItem);

          if (data.files.length === 1) {
            checkbox.checked = true;
          }
        });

        // Store torrent statistics if available
        if (data.stats) {
          currentStats = data.stats;
        }

        if (data.files.length === 1) {
          setTimeout(() => {
            document.getElementById("btnSelectFiles").click();
          }, 500);
        } else {
          updateStep(4);
        }
      });

      ipcRenderer.on("player-launched", (event, data) => {
        addLog(
          "–ü–ª–µ–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –≤—Ä–µ–º—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞ –Ω–∞ –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è",
          "success"
        );
        
        // Move to step 6
        updateStep(6);
        
        // Use setTimeout to ensure DOM is updated
        setTimeout(() => {
          // Hide loading spinner
          const playerLoading = document.getElementById("playerLoading");
          if (playerLoading) {
            playerLoading.style.display = "none";
          }
          
          // Show stats
          showStatsOnStep6();
          
          // Show live indicator
          const liveIndicator = document.getElementById("liveIndicator");
          if (liveIndicator) {
            liveIndicator.classList.remove("hidden");
          }
          
          // Mark step as completed
          document
            .querySelector('.step[data-step="6"]')
            .classList.remove("active");
          document
            .querySelector('.step[data-step="6"]')
            .classList.add("completed");
        }, 100);
      });

      ipcRenderer.on("error", (event, data) => {
        addLog(`–û—à–∏–±–∫–∞: ${data.message}`, "error");
        setStepError(currentStep);
      });

      ipcRenderer.on("player-path-selected", (event, data) => {
        addLog(`–í—ã–±—Ä–∞–Ω –ø–ª–µ–µ—Ä: ${data.path}`, "success");
        ipcRenderer.send("player-selected", {
          playerType: "custom",
          path: data.path,
        });
      });

      function showStatsOnStep6() {
        // Hide loading spinner first
        const playerLoading = document.getElementById("playerLoading");
        if (playerLoading) {
          playerLoading.style.display = "none";
        }
        
        // Show stats block on step 6
        const statsBlock = document.getElementById("torrentStats");
        if (statsBlock && currentStats) {
          statsBlock.classList.remove("hidden");
          
          // Update with current stats
          document.getElementById("statServerName").textContent = selectedServerName || "-";
          document.getElementById("statTotalPeers").textContent = currentStats.totalPeers;
          document.getElementById("statActivePeers").textContent = currentStats.activePeers;
          document.getElementById("statDownloadSpeed").textContent = 
            (currentStats.downloadSpeed * 8 / 1024 / 1024).toFixed(2) + " –ú–±–∏—Ç/—Å";
          document.getElementById("statClientDownloadSpeed").textContent = 
            (currentStats.clientDownloadSpeed * 8 / 1024 / 1024).toFixed(2) + " –ú–±–∏—Ç/—Å";
          document.getElementById("statTorrentSize").textContent = 
            formatFileSize(currentStats.torrentSize);
        }
      }

      ipcRenderer.on("auto-choose-player", (event, data) => {
        document.getElementById("btnChoosePlayer").click();
      });

      ipcRenderer.on("stats-update", (event, data) => {
        if (data.stats) {
          const stats = data.stats;
          currentStats = stats; // Store current stats
          
          // Update stats without animation
          const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
              element.textContent = value;
            }
          };
          
          updateElement("statServerName", selectedServerName || "-");
          updateElement("statTotalPeers", stats.totalPeers.toString());
          updateElement("statActivePeers", stats.activePeers.toString());
          updateElement("statDownloadSpeed", (stats.downloadSpeed * 8 / 1024 / 1024).toFixed(2) + " –ú–±–∏—Ç/—Å");
          updateElement("statClientDownloadSpeed", (stats.clientDownloadSpeed * 8 / 1024 / 1024).toFixed(2) + " –ú–±–∏—Ç/—Å");
          updateElement("statTorrentSize", formatFileSize(stats.torrentSize));
        }
      });

      function formatFileSize(bytes) {
        const units = ["B", "KB", "MB", "GB", "TB"];
        let size = bytes;
        let unitIndex = 0;

        while (size >= 1024 && unitIndex < units.length - 1) {
          size /= 1024;
          unitIndex++;
        }

        return `${size.toFixed(1)} ${units[unitIndex]}`;
      }

      function copyLogToClipboard() {
        const logContainer = document.getElementById("logContainer");
        const logEntries = logContainer.querySelectorAll(".log-entry");

        let logText = "";
        logEntries.forEach((entry) => {
          logText += entry.textContent + "\n";
        });

        navigator.clipboard
          .writeText(logText)
          .then(() => {
            addLog("–õ–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "success");
          })
          .catch(() => {
            const textArea = document.createElement("textarea");
            textArea.value = logText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            addLog("–õ–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (fallback)", "success");
          });
      }

      updateStep(1);

      // Cleanup on window close
      window.addEventListener('beforeunload', () => {
        if (monitorWs) {
          monitorWs.close();
        }
      });
    </script>
  </body>
</html>
